{"meta":{"file_version":"4.0.2","database_name":"eleventhree","export_timestamp":"2023-08-23T13:26:08.562576+00:00","export_library_fqn":["growatt"],"database_schema_version":"4.5.17"},"types":[{"fqn":["growatt","solar_data_collector"],"scripts":[{"run":false,"owner":"cesmiihq","script":"# Purpose: Library to support getting data from the Growatt API\r\n#   Subset of https://github.com/indykoning/PyPi_GrowattServer\r\n#   Used under a MIT license\r\nname = \"growattServer\"\r\n\r\nimport datetime\r\nfrom enum import IntEnum\r\nimport hashlib\r\nimport json\r\nimport requests\r\nimport warnings\r\nfrom random import randint\r\n\r\ndef hash_password(password):\r\n    \"\"\"\r\n    Normal MD5, except add c if a byte of the digest is less than 10.\r\n    \"\"\"\r\n    password_md5 = hashlib.md5(password.encode('utf-8')).hexdigest()\r\n    for i in range(0, len(password_md5), 2):\r\n        if password_md5[i] == '0':\r\n            password_md5 = password_md5[0:i] + 'c' + password_md5[i + 1:]\r\n    return password_md5\r\n\r\nclass Timespan(IntEnum):\r\n    hour = 0\r\n    day = 1\r\n    month = 2\r\n\r\nclass GrowattApi:\r\n    server_url = 'https://server-api.growatt.com/'\r\n    agent_identifier = \"Dalvik/2.1.0 (Linux; U; Android 12; https://github.com/indykoning/PyPi_GrowattServer)\"\r\n\r\n    def __init__(self, add_random_user_id=False, agent_identifier=None):\r\n        if (agent_identifier != None):\r\n          self.agent_identifier = agent_identifier\r\n\r\n        #If a random user id is required, generate a 5 digit number and add it to the user agent\r\n        if (add_random_user_id):\r\n          random_number = ''.join([\"{}\".format(randint(0,9)) for num in range(0,5)])\r\n          self.agent_identifier += \" - \" + random_number\r\n\r\n        self.session = requests.Session()\r\n        self.session.hooks = {\r\n            'response': lambda response, *args, **kwargs: response.raise_for_status()\r\n        }\r\n\r\n        headers = {'User-Agent': self.agent_identifier}\r\n        self.session.headers.update(headers)\r\n    \r\n    def testing(self, whatever):\r\n        return whatever\r\n\r\n    def __get_date_string(self, timespan=None, date=None):\r\n        if timespan is not None:\r\n         assert timespan in Timespan\r\n\r\n        if date is None:\r\n          date = datetime.datetime.now()\r\n\r\n        date_str=\"\"\r\n        if timespan == Timespan.month:\r\n            date_str = date.strftime('%Y-%m')\r\n        else:\r\n            date_str = date.strftime('%Y-%m-%d')\r\n\r\n        return date_str\r\n\r\n    def get_url(self, page):\r\n        \"\"\"\r\n        Simple helper function to get the page url/\r\n        \"\"\"\r\n        return self.server_url + page\r\n\r\n    def login(self, username, password, is_password_hashed=False):\r\n        \"\"\"\r\n        Log the user in.\r\n\r\n        Returns\r\n        'data' -- A List containing Objects containing the folowing\r\n            'plantName' -- Friendly name of the plant\r\n            'plantId'   -- The ID of the plant\r\n        'service'\r\n        'quality'\r\n        'isOpenSmartFamily'\r\n        'totalData' -- An Object\r\n        'success'   -- True or False\r\n        'msg'\r\n        'app_code'\r\n        'user' -- An Object containing a lot of user information\r\n            'uid'\r\n            'userLanguage'\r\n            'inverterGroup' -- A List\r\n            'timeZone' -- A Number\r\n            'lat'\r\n            'lng'\r\n            'dataAcqList' -- A List\r\n            'type'\r\n            'accountName' -- The username\r\n            'password' -- The password hash of the user\r\n            'isValiPhone'\r\n            'kind'\r\n            'mailNotice' -- True or False\r\n            'id'\r\n            'lasLoginIp'\r\n            'lastLoginTime'\r\n            'userDeviceType'\r\n            'phoneNum'\r\n            'approved' -- True or False\r\n            'area' -- Continent of the user\r\n            'smsNotice' -- True or False\r\n            'isAgent'\r\n            'token'\r\n            'nickName'\r\n            'parentUserId'\r\n            'customerCode'\r\n            'country'\r\n            'isPhoneNumReg'\r\n            'createDate'\r\n            'rightlevel'\r\n            'appType'\r\n            'serverUrl'\r\n            'roleId'\r\n            'enabled' -- True or False\r\n            'agentCode'\r\n            'inverterList' -- A list\r\n            'email'\r\n            'company'\r\n            'activeName'\r\n            'codeIndex'\r\n            'appAlias'\r\n            'isBigCustomer'\r\n            'noticeType'\r\n        \"\"\"\r\n        if not is_password_hashed:\r\n            password = hash_password(password)\r\n\r\n        response = self.session.post(self.get_url('newTwoLoginAPI.do'), data={\r\n            'userName': username,\r\n            'password': password\r\n        })\r\n        data = json.loads(response.content.decode('utf-8'))['back']\r\n        if data['success']:\r\n            data.update({\r\n                'userId': data['user']['id'],\r\n                'userLevel': data['user']['rightlevel']\r\n            })\r\n        return data\r\n\r\n    def plant_list(self, user_id):\r\n        \"\"\"\r\n        Get a list of plants connected to this account.\r\n        \"\"\"\r\n        response = self.session.get(self.get_url('PlantListAPI.do'),\r\n                                    params={'userId': user_id},\r\n                                    allow_redirects=False)\r\n\r\n        data = json.loads(response.content.decode('utf-8'))\r\n        return data['back']\r\n\r\n    def plant_detail(self, plant_id, timespan, date=None):\r\n        \"\"\"\r\n        Get plant details for specified timespan.\r\n        \"\"\"\r\n        date_str = self.__get_date_string(timespan, date)\r\n\r\n        response = self.session.get(self.get_url('PlantDetailAPI.do'), params={\r\n            'plantId': plant_id,\r\n            'type': timespan.value,\r\n            'date': date_str\r\n        })\r\n        data = json.loads(response.content.decode('utf-8'))\r\n        return data['back']\r\n\r\n    def inverter_data(self, inverter_id, date=None):\r\n        \"\"\"\r\n        Get inverter data for specified date or today.\r\n        \"\"\"\r\n        date_str = self.__get_date_string(date=date)\r\n        response = self.session.get(self.get_url('newInverterAPI.do'), params={\r\n            'op': 'getInverterData',\r\n            'id': inverter_id,\r\n            'type': 1,\r\n            'date': date_str\r\n        })\r\n        data = json.loads(response.content.decode('utf-8'))\r\n        return data\r\n\r\n    def inverter_detail(self, inverter_id):\r\n        \"\"\"\r\n        Get \"All parameters\" from PV inverter.\r\n        \"\"\"\r\n        response = self.session.get(self.get_url('newInverterAPI.do'), params={\r\n            'op': 'getInverterDetailData',\r\n            'inverterId': inverter_id\r\n        })\r\n\r\n        data = json.loads(response.content.decode('utf-8'))\r\n        return data\r\n\r\n    def inverter_detail_two(self, inverter_id):\r\n        \"\"\"\r\n        Get \"All parameters\" from PV inverter.\r\n        \"\"\"\r\n        response = self.session.get(self.get_url('newInverterAPI.do'), params={\r\n            'op': 'getInverterDetailData_two',\r\n            'inverterId': inverter_id\r\n        })\r\n\r\n        data = json.loads(response.content.decode('utf-8'))\r\n        return data\r\n\r\n    def tlx_data(self, tlx_id, date=None):\r\n        \"\"\"\r\n        Get inverter data for specified date or today.\r\n        \"\"\"\r\n        date_str = self.__get_date_string(date=date)\r\n        response = self.session.get(self.get_url('newTlxApi.do'), params={\r\n            'op': 'getTlxData',\r\n            'id': tlx_id,\r\n            'type': 1,\r\n            'date': date_str\r\n        })\r\n        data = json.loads(response.content.decode('utf-8'))\r\n        return data\r\n\r\n    def tlx_detail(self, tlx_id):\r\n        \"\"\"\r\n        Get \"All parameters\" from PV inverter.\r\n        \"\"\"\r\n        response = self.session.get(self.get_url('newTlxApi.do'), params={\r\n            'op': 'getTlxDetailData',\r\n            'id': tlx_id\r\n        })\r\n\r\n        data = json.loads(response.content.decode('utf-8'))\r\n        return data\r\n\r\n    def mix_info(self, mix_id, plant_id = None):\r\n        \"\"\"\r\n        Returns high level values from Mix device\r\n\r\n        Keyword arguments:\r\n        mix_id -- The serial number (device_sn) of the inverter\r\n        plant_id -- The ID of the plant (the mobile app uses this but it does not appear to be necessary) (default None)\r\n\r\n        Returns:\r\n        'acChargeEnergyToday' -- ??? 2.7\r\n        'acChargeEnergyTotal' -- ??? 25.3\r\n        'acChargePower' -- ??? 0\r\n        'capacity': '45' -- The current remaining capacity of the batteries (same as soc but without the % sign)\r\n        'eBatChargeToday' -- Battery charged today in kWh\r\n        'eBatChargeTotal' -- Battery charged total (all time) in kWh\r\n        'eBatDisChargeToday' -- Battery discharged today in kWh\r\n        'eBatDisChargeTotal' -- Battery discharged total (all time) in kWh\r\n        'epvToday' -- Energy generated from PVs today in kWh\r\n        'epvTotal' -- Energy generated from PVs total (all time) in kWh\r\n        'isCharge'-- ??? 0 - Possible a 0/1 based on whether or not the battery is charging\r\n        'pCharge1' -- ??? 0\r\n        'pDischarge1' -- Battery discharging rate in W\r\n        'soc' -- Statement of charge including % symbol\r\n        'upsPac1' -- ??? 0\r\n        'upsPac2' -- ??? 0\r\n        'upsPac3' -- ??? 0\r\n        'vbat' -- Battery Voltage\r\n        'vbatdsp' -- ??? 51.8\r\n        'vpv1' -- Voltage PV1\r\n        'vpv2' -- Voltage PV2\r\n        \"\"\"\r\n        request_params={\r\n            'op': 'getMixInfo',\r\n            'mixId': mix_id\r\n        }\r\n\r\n        if (plant_id):\r\n          request_params['plantId'] = plant_id\r\n\r\n        response = self.session.get(self.get_url('newMixApi.do'), params=request_params)\r\n\r\n        data = json.loads(response.content.decode('utf-8'))\r\n        return data['obj']\r\n\r\n    def mix_totals(self, mix_id, plant_id):\r\n        \"\"\"\r\n        Returns \"Totals\" values from Mix device\r\n\r\n        Keyword arguments:\r\n        mix_id -- The serial number (device_sn) of the inverter\r\n        plant_id -- The ID of the plant\r\n\r\n        Returns:\r\n        'echargetoday' -- Battery charged today in kWh (same as eBatChargeToday from mix_info)\r\n        'echargetotal' -- Battery charged total (all time) in kWh (same as eBatChargeTotal from mix_info)\r\n        'edischarge1Today' -- Battery discharged today in kWh (same as eBatDisChargeToday from mix_info)\r\n        'edischarge1Total' -- Battery discharged total (all time) in kWh (same as eBatDisChargeTotal from mix_info)\r\n        'elocalLoadToday' -- Load consumption today in kWh\r\n        'elocalLoadTotal' -- Load consumption total (all time) in kWh\r\n        'epvToday' -- Energy generated from PVs today in kWh (same as epvToday from mix_info)\r\n        'epvTotal' -- Energy generated from PVs total (all time) in kWh (same as epvTotal from mix_info)\r\n        'etoGridToday' -- Energy exported to the grid today in kWh\r\n        'etogridTotal' -- Energy exported to the grid total (all time) in kWh\r\n        'photovoltaicRevenueToday' -- Revenue earned from PV today in 'unit' currency\r\n        'photovoltaicRevenueTotal' -- Revenue earned from PV total (all time) in 'unit' currency\r\n        'unit' -- Unit of currency for 'Revenue'\r\n        \"\"\"\r\n        response = self.session.post(self.get_url('newMixApi.do'), params={\r\n            'op': 'getEnergyOverview',\r\n            'mixId': mix_id,\r\n            'plantId': plant_id\r\n        })\r\n\r\n        data = json.loads(response.content.decode('utf-8'))\r\n        return data['obj']\r\n\r\n    def mix_system_status(self, mix_id, plant_id):\r\n        \"\"\"\r\n        Returns current \"Status\" from Mix device\r\n\r\n        Keyword arguments:\r\n        mix_id -- The serial number (device_sn) of the inverter\r\n        plant_id -- The ID of the plant\r\n\r\n        Returns:\r\n        'SOC' -- Statement of charge (remaining battery %)\r\n        'chargePower' -- Battery charging rate in kw\r\n        'fAc' -- Frequency (Hz)\r\n        'lost' -- System status e.g. 'mix.status.normal'\r\n        'pLocalLoad' -- Load conumption in kW\r\n        'pPv1' -- PV1 Wattage in W\r\n        'pPv2' -- PV2 Wattage in W\r\n        'pactogrid' -- Export to grid rate in kW\r\n        'pactouser' -- Import from grid rate in kW\r\n        'pdisCharge1' -- Discharging batteries rate in kW\r\n        'pmax' -- ??? 6 ??? PV Maximum kW ??\r\n        'ppv' -- PV combined Wattage in kW\r\n        'priorityChoose' -- Priority setting - 0=Local load\r\n        'status' -- System statue - ENUM - Unknown values\r\n        'unit' -- Unit of measurement e.g. 'kW'\r\n        'upsFac' -- ??? 0\r\n        'upsVac1' -- ??? 0\r\n        'uwSysWorkMode' -- ??? 6\r\n        'vAc1' -- Grid voltage in V\r\n        'vBat' -- Battery voltage in V\r\n        'vPv1' -- PV1 voltage in V\r\n        'vPv2' -- PV2 voltage in V\r\n        'vac1' -- Grid voltage in V (same as vAc1)\r\n        'wBatteryType' -- ??? 1\r\n        \"\"\"\r\n        response = self.session.post(self.get_url('newMixApi.do'), params={\r\n            'op': 'getSystemStatus_KW',\r\n            'mixId': mix_id,\r\n            'plantId': plant_id\r\n        })\r\n\r\n        data = json.loads(response.content.decode('utf-8'))\r\n        return data['obj']\r\n\r\n    def mix_detail(self, mix_id, plant_id, timespan=Timespan.hour, date=None):\r\n        \"\"\"\r\n        Get Mix details for specified timespan\r\n\r\n        Keyword arguments:\r\n        mix_id -- The serial number (device_sn) of the inverter\r\n        plant_id -- The ID of the plant\r\n        timespan -- The ENUM value conforming to the time window you want e.g. hours from today, days, or months (Default Timespan.hour)\r\n        date -- The date you are interested in (Default datetime.datetime.now())\r\n\r\n        Returns:\r\n        A chartData object where each entry is for a specific 5 minute window e.g. 00:05 and 00:10 respectively (below)\r\n        'chartData': {   '00:05': {   'pacToGrid' -- Export rate to grid in kW\r\n                                      'pacToUser' -- Import rate from grid in kW\r\n                                      'pdischarge' -- Battery discharge in kW\r\n                                      'ppv' -- Solar generation in kW\r\n                                      'sysOut' -- Load consumption in kW\r\n                                  },\r\n                         '00:10': {   'pacToGrid': '0',\r\n                                      'pacToUser': '0.93',\r\n                                      'pdischarge': '0',\r\n                                      'ppv': '0',\r\n                                      'sysOut': '0.93'},\r\n                          ......\r\n                     }\r\n        'eAcCharge' -- Exported to grid in kWh\r\n        'eCharge' -- System production in kWh = Self-consumption + Exported to Grid\r\n        'eChargeToday' -- Load consumption from solar in kWh\r\n        'eChargeToday1' -- Self-consumption in kWh\r\n        'eChargeToday2' -- Self-consumption in kWh (eChargeToday + echarge1)\r\n        'echarge1' -- Load consumption from battery in kWh\r\n        'echargeToat' -- Total battery discharged (all time) in kWh\r\n        'elocalLoad' -- Load consumption in kW (battery + solar + imported)\r\n        'etouser' -- Load consumption imported from grid in kWh\r\n        'photovoltaic' -- Load consumption from solar in kWh (same as eChargeToday)\r\n        'ratio1' -- % of system production that is self-consumed\r\n        'ratio2' -- % of system production that is exported\r\n        'ratio3' -- % of Load consumption that is \"self consumption\"\r\n        'ratio4' -- % of Load consumption that is \"imported from grid\"\r\n        'ratio5' -- % of Self consumption that is directly from Solar\r\n        'ratio6' -- % of Self consumption that is from batteries\r\n        'unit' -- Unit of measurement e.g kWh\r\n        'unit2' -- Unit of measurement e.g kW\r\n\r\n\r\n        NOTE - It is possible to calculate the PV generation that went into charging the batteries by performing the following calculation:\r\n        Solar to Battery = Solar Generation - Export to Grid - Load consumption from solar\r\n                           epvToday (from mix_info) - eAcCharge - eChargeToday\r\n        \"\"\"\r\n        date_str = self.__get_date_string(timespan, date)\r\n\r\n        response = self.session.post(self.get_url('newMixApi.do'), params={\r\n            'op': 'getEnergyProdAndCons_KW',\r\n            'plantId': plant_id,\r\n            'mixId': mix_id,\r\n            'type': timespan.value,\r\n            'date': date_str\r\n        })\r\n        data = json.loads(response.content.decode('utf-8'))\r\n\r\n        return data['obj']\r\n\r\n    def dashboard_data(self, plant_id, timespan=Timespan.hour, date=None):\r\n        \"\"\"\r\n        Get 'dashboard' data for specified timespan\r\n        NOTE - All numerical values returned by this api call include units e.g. kWh or %\r\n             - Many of the 'total' values that are returned for a Mix system are inaccurate on the system this was tested against.\r\n               However, the statistics that are correct are not available on any other interface, plus these values may be accurate for\r\n               non-mix types of system. Where the values have been proven to be inaccurate they are commented below.\r\n\r\n        Keyword arguments:\r\n        plant_id -- The ID of the plant\r\n        timespan -- The ENUM value conforming to the time window you want e.g. hours from today, days, or months (Default Timespan.hour)\r\n        date -- The date you are interested in (Default datetime.datetime.now())\r\n\r\n        Returns:\r\n        A chartData object where each entry is for a specific 5 minute window e.g. 00:05 and 00:10 respectively (below)\r\n        NOTE: The keys are interpreted differently, the examples below describe what they are used for in a 'Mix' system\r\n        'chartData': {   '00:05': {   'pacToUser' -- Power from battery in kW\r\n                                      'ppv' -- Solar generation in kW\r\n                                      'sysOut' -- Load consumption in kW\r\n                                      'userLoad' -- Export in kW\r\n                                  },\r\n                         '00:10': {   'pacToUser': '0',\r\n                                      'ppv': '0',\r\n                                      'sysOut': '0.7',\r\n                                      'userLoad': '0'},\r\n                          ......\r\n                     }\r\n        'chartDataUnit' -- Unit of measurement e.g. 'kW',\r\n        'eAcCharge' -- Energy exported to the grid in kWh e.g. '20.5kWh' (not accurate for Mix systems)\r\n        'eCharge' -- System production in kWh = Self-consumption + Exported to Grid e.g '23.1kWh' (not accurate for Mix systems - actually showing the total 'load consumption'\r\n        'eChargeToday1' -- Self-consumption of PPV (possibly including excess diverted to batteries) in kWh e.g. '2.6kWh' (not accurate for Mix systems)\r\n        'eChargeToday2' -- Total self-consumption (PPV consumption(eChargeToday2Echarge1) + Battery Consumption(echarge1)) e.g. '10.1kWh' (not accurate for Mix systems)\r\n        'eChargeToday2Echarge1' -- Self-consumption of PPV only e.g. '0.8kWh' (not accurate for Mix systems)\r\n        'echarge1' -- Self-consumption from Battery only e.g. '9.3kWh'\r\n        'echargeToat' -- Not used on Dashboard view, likely to be total battery discharged e.g. '152.1kWh'\r\n        'elocalLoad' -- Total load consumption (etouser + eChargeToday2) e.g. '20.3kWh', (not accurate for Mix systems)\r\n        'etouser'-- Energy imported from grid today (includes both directly used by load and AC battery charging e.g. '10.2kWh'\r\n        'keyNames' -- Keys to be used for the graph data e.g. ['Solar', 'Load Consumption', 'Export To Grid', 'From Battery']\r\n        'photovoltaic' -- Same as eChargeToday2Echarge1 e.g. '0.8kWh'\r\n        'ratio1' -- % of 'Solar production' that is self-consumed e.g. '11.3%' (not accurate for Mix systems)\r\n        'ratio2' -- % of 'Solar production' that is exported e.g. '88.7%' (not accurate for Mix systems)\r\n        'ratio3' -- % of 'Load consumption' that is self consumption e.g. '49.8%' (not accurate for Mix systems)\r\n        'ratio4' -- % of 'Load consumption' that is imported from the grid e.g '50.2%' (not accurate for Mix systems)\r\n        'ratio5' -- % of Self consumption that is from batteries e.g. '92.1%' (not accurate for Mix systems)\r\n        'ratio6' -- % of Self consumption that is directly from Solar e.g. '7.9%' (not accurate for Mix systems)\r\n        \"\"\"\r\n        date_str = self.__get_date_string(timespan, date)\r\n\r\n        response = self.session.post(self.get_url('newPlantAPI.do'), params={\r\n            'action': \"getEnergyStorageData\",\r\n            'date': date_str,\r\n            'type': timespan.value,\r\n            'plantId': plant_id\r\n        })\r\n\r\n        data = json.loads(response.content.decode('utf-8'))\r\n        return data\r\n\r\n    def storage_detail(self, storage_id):\r\n        \"\"\"\r\n        Get \"All parameters\" from battery storage.\r\n        \"\"\"\r\n        response = self.session.get(self.get_url('newStorageAPI.do'), params={\r\n            'op': 'getStorageInfo_sacolar',\r\n            'storageId': storage_id\r\n        })\r\n\r\n        data = json.loads(response.content.decode('utf-8'))\r\n        return data\r\n\r\n    def storage_params(self, storage_id):\r\n        \"\"\"\r\n        Get much more detail from battery storage.\r\n        \"\"\"\r\n        response = self.session.get(self.get_url('newStorageAPI.do'), params={\r\n            'op': 'getStorageParams_sacolar',\r\n            'storageId': storage_id\r\n        })\r\n\r\n        data = json.loads(response.content.decode('utf-8'))\r\n        return data\r\n\r\n    def storage_energy_overview(self, plant_id, storage_id):\r\n        \"\"\"\r\n        Get some energy/generation overview data.\r\n        \"\"\"\r\n        response = self.session.post(self.get_url('newStorageAPI.do?op=getEnergyOverviewData_sacolar'), params={\r\n            'plantId': plant_id,\r\n            'storageSn': storage_id\r\n        })\r\n\r\n        data = json.loads(response.content.decode('utf-8'))\r\n        return data['obj']\r\n\r\n    def inverter_list(self, plant_id):\r\n        \"\"\"\r\n        Use device_list, it's more descriptive since the list contains more than inverters.\r\n        \"\"\"\r\n        warnings.warn(\"This function may be deprecated in the future because naming is not correct, use device_list instead\", DeprecationWarning)\r\n        return self.device_list(plant_id)\r\n\r\n    def device_list(self, plant_id):\r\n        \"\"\"\r\n        Get a list of all devices connected to plant.\r\n        \"\"\"\r\n        return self.plant_info(plant_id)['deviceList']\r\n\r\n    def plant_info(self, plant_id):\r\n        \"\"\"\r\n        Get basic plant information with device list.\r\n        \"\"\"\r\n        response = self.session.get(self.get_url('newTwoPlantAPI.do'), params={\r\n            'op': 'getAllDeviceList',\r\n            'plantId': plant_id,\r\n            'pageNum': 1,\r\n            'pageSize': 1\r\n        })\r\n\r\n        data = json.loads(response.content.decode('utf-8'))\r\n        return data\r\n\r\n    def get_plant_settings(self, plant_id):\r\n        \"\"\"\r\n        Returns a dictionary containing the settings for the specified plant\r\n\r\n        Keyword arguments:\r\n        plant_id -- The id of the plant you want the settings of\r\n\r\n        Returns:\r\n        A python dictionary containing the settings for the specified plant\r\n        \"\"\"\r\n        response = self.session.get(self.get_url('newPlantAPI.do'), params={\r\n            'op': 'getPlant',\r\n            'plantId': plant_id\r\n        })\r\n        data = json.loads(response.content.decode('utf-8'))\r\n        return \r\n        ","document":{"template":false},"description":"Python API library for Growatt. From https://github.com/indykoning/PyPi_GrowattServer, used under a MIT license.","edit_status":1,"output_type":"headless","script_type":"python","display_name":"Growatt API","relative_name":"growatt_api","initial_inputs":{"start_timestamp":"2023-08-07T14:54:23.000+00:00","interval_seconds":"60"},"cron_expression":"0 * * * * ? *","exec_on_derived":false,"updated_timestamp":"2023-08-07T16:00:45.349252+00:00","max_acceptable_run_secs":0,"use_outputs_from_last_run":false},{"run":true,"owner":"cesmiihq","script":"# Purpose: Get data from Growatt API\r\n#   Depends on the Growatt API Script\r\n#   This script assumes it is configured with a \"custom\" parameter that defines API credentials in one of two ways\r\n#   For a single user: {\"username\":\"YOURGROWATTUSERNAME\",\"password\":\"YOURGROWATTPASSWORD\"}\r\n#   For multiple users: {\"growattCredentials\":\"WIFIADAPTERSERIALNUMBER1,GROWATTUSERNAME1,GROWATTPASSWORD1|WIFIADAPTERSERIALNUMBER2,GROWATTUSERNAME2,GROWATTPASSWORD2\"}\r\n#\r\nimport json\r\nfrom datetime import datetime, timedelta\r\n# reverse engineering\r\nimport pickle\r\nfrom pprint import pprint\r\nfrom inspect import getmembers, isfunction\r\n# /reverse engineering\r\nfrom thinkiq.model.equipment import Equipment\r\nfrom thinkiq.model.attribute import Attribute\r\nfrom thinkiq.history import value_stream, StatusCodes\r\nfrom thinkiq.history.vst import Vst\r\nfrom thinkiq_context import get_context\r\nfrom growatt_api_73152 import GrowattApi\r\n\r\nprint (GrowattApi.testing(GrowattApi, \"Updating data from Growatt API...\"))\r\n\r\n# Find out what we're updating\r\ncontext = get_context()                                 # the context object holds runtime information such as the equipment id and data stored between runs\r\nparent_id = context.std_inputs.node_id\r\nparent_node = Equipment.get_from_id(parent_id)\r\n#print(vars(parent_node))\r\n\r\n# Find its attributes (hack around poor documentation, should be a better way!)\r\nattribs = []\r\nfor var in vars(parent_node):\r\n    try:\r\n        #pprint(getattr(parent_node.attributes, var))\r\n        attribs.append(getattr(parent_node.attributes, var))\r\n    except:\r\n        #couldn't get the current from the attributes collection, so its not really an attribute\r\n        pass\r\n\r\n# Find credentials\r\nusername = \"\"\r\npassword = \"\"\r\ntry:\r\n    username = context.custom_inputs.username\r\n    password = context.custom_inputs.password\r\nexcept:\r\n    try:\r\n        credentials = context.custom_inputs.growattCredentials\r\n        credentials = credentials.split(\"|\")\r\n        for credential in credentials:\r\n            credParts = credential.split(\",\")\r\n            serialnumber = credParts[0]\r\n            if (serialnumber.lower() == parent_node.display_name.lower()):\r\n                username = credParts[1]\r\n                password = credParts[2]\r\n    except:\r\n        print (\"No Growatt credentials set in custom inputs. Quitting\")\r\n        quit()        \r\nprint (\"Found credentials for \" + parent_node.display_name)\r\n\r\n# Make times\r\ntime_start = datetime.now()-timedelta(seconds=10)\r\ntime_end = datetime.now()\r\n\r\n# Find data for this user and this data collector\r\napi = GrowattApi()\r\napi.server_url = \"https://server-us.growatt.com/\"\r\nlogin_response = api.login(username, password)\r\nprint(login_response)\r\nplant_list = api.plant_list(login_response['user']['id'])\r\nprint(plant_list)\r\nfor plant in plant_list['data']:\r\n  plant_id = plant['plantId']\r\n  plant_name = plant['plantName']\r\n  plant_info=api.plant_info(plant_id)\r\n  print(plant_info)\r\n  for device in plant_info['deviceList']:\r\n    device_sn = device['deviceSn']\r\n    if device_sn.lower() == parent_node.display_name.lower():\r\n        print(\"Found \" + parent_node.display_name + \" in plant \" + plant_name)\r\n        #try:\r\n        for attrib in attribs:\r\n            #pprint(attrib)\r\n            if attrib.description in device.keys():\r\n                strVal = device[attrib.description]\r\n            else:\r\n                if attrib.description in plant_info.keys():\r\n                    strVal = plant_info[attrib.description]\r\n            numVal = ''\r\n            for char in strVal:\r\n                if char in '1234567890.':\r\n                    numVal += char\r\n            print (\" - Need to update \" + attrib.relative_name + \" from datasource: \" + attrib.description + \", with value: \" + str(numVal))\r\n            \r\n            # Create value as stream\r\n            vs = value_stream.ValueStream(None, time_start, time_end)\r\n            vst1 = Vst(numVal, StatusCodes.Good, time_start)\r\n            print (vst1)\r\n            vs.add_vst(vst1)\r\n\r\n            attrib.save_value_stream(vs)\r\n        #except:\r\n        #    print(\"Could not parse response attributes\")\r\n        print(\"Plant data: \" + json.dumps(plant_info), end='\\n')\r\n        print(\"Device data: \" + json.dumps(device), end='\\n')\r\n\r\n","document":{"template":false},"description":"Schedule this script.\r\nInclude your Growatt credentials (see code comments for examples)","edit_status":1,"output_type":"headless","script_type":"python","display_name":"Growatt Fetch","relative_name":"growatt_fetch","initial_inputs":{"start_timestamp":"2023-08-07T13:37:30.000+00:00","interval_seconds":"60","growattCredentials":""},"cron_expression":"0 0/5 * * * ? *","exec_on_derived":false,"updated_timestamp":"2023-08-23T13:20:14.817648+00:00","max_acceptable_run_secs":0,"use_outputs_from_last_run":false}],"document":null,"attributes":[{"icon":null,"document":null,"data_type":"float","is_hidden":false,"max_value":100,"min_value":0,"expression":null,"importance":10,"description":"capacity","edit_status":1,"is_required":false,"display_name":"Battery Level","default_value":null,"relative_name":"battery_level","decimal_places":2,"source_category":"dynamic","attribute_limits":[],"updated_timestamp":"2023-08-07T16:57:58.462006+00:00","attribute_type_fqn":null,"enumeration_type_fqn":null,"interpolation_method":"linear","unlink_relative_name":false,"object_history_type_id":null,"default_enumeration_values":null,"default_measurement_unit_fqn":["thinkiq_base_library","percent"]},{"icon":null,"document":null,"data_type":"float","is_hidden":false,"max_value":null,"min_value":null,"expression":null,"importance":10,"description":"activePower","edit_status":1,"is_required":false,"display_name":"Active Power","default_value":null,"relative_name":"active_power","decimal_places":2,"source_category":"dynamic","attribute_limits":[],"updated_timestamp":"2023-08-07T19:01:30.975884+00:00","attribute_type_fqn":null,"enumeration_type_fqn":null,"interpolation_method":"linear","unlink_relative_name":false,"object_history_type_id":null,"default_enumeration_values":null,"default_measurement_unit_fqn":["thinkiq_base_library","watt"]},{"icon":null,"document":null,"data_type":"float","is_hidden":false,"max_value":null,"min_value":null,"expression":null,"importance":10,"description":"apparentPower","edit_status":1,"is_required":false,"display_name":"Apparent Power","default_value":null,"relative_name":"apparent_power","decimal_places":2,"source_category":"dynamic","attribute_limits":[],"updated_timestamp":"2023-08-07T19:04:20.995532+00:00","attribute_type_fqn":null,"enumeration_type_fqn":null,"interpolation_method":"linear","unlink_relative_name":false,"object_history_type_id":null,"default_enumeration_values":null,"default_measurement_unit_fqn":null},{"icon":null,"document":null,"data_type":"float","is_hidden":false,"max_value":null,"min_value":null,"expression":null,"importance":10,"description":"todayEnergy","edit_status":1,"is_required":false,"display_name":"Energy Generated Today","default_value":null,"relative_name":"energy_generated_today","decimal_places":2,"source_category":"dynamic","attribute_limits":[],"updated_timestamp":"2023-08-07T21:16:18.619071+00:00","attribute_type_fqn":null,"enumeration_type_fqn":null,"interpolation_method":"linear","unlink_relative_name":false,"object_history_type_id":null,"default_enumeration_values":null,"default_measurement_unit_fqn":["thinkiq_base_library","kilowatt_hour"]},{"icon":null,"document":null,"data_type":"float","is_hidden":false,"max_value":null,"min_value":null,"expression":null,"importance":10,"description":"energy","edit_status":1,"is_required":false,"display_name":"Total Energy Generated","default_value":null,"relative_name":"total_energy_generated","decimal_places":2,"source_category":"dynamic","attribute_limits":[],"updated_timestamp":"2023-08-07T21:14:57.619878+00:00","attribute_type_fqn":null,"enumeration_type_fqn":null,"interpolation_method":"linear","unlink_relative_name":false,"object_history_type_id":null,"default_enumeration_values":null,"default_measurement_unit_fqn":["thinkiq_base_library","kilowatt_hour"]}],"description":null,"edit_status":1,"display_name":"Solar Data Collector","opcua_methods":[],"relative_name":"solar_data_collector","classification":"equipment","child_equipment":[],"sub_type_of_fqn":["thinkiq_base_library","equipment"],"updated_timestamp":"2023-08-07T14:10:02.005918+00:00","unlink_relative_name":false},{"fqn":["growatt","solar_plant"],"scripts":[],"document":null,"attributes":[],"description":null,"edit_status":1,"display_name":"Solar Plant","opcua_methods":[],"relative_name":"solar_plant","classification":"place","child_equipment":[],"sub_type_of_fqn":["thinkiq_base_library","plant"],"updated_timestamp":"2023-08-07T14:07:45.455596+00:00","unlink_relative_name":false},{"fqn":["thinkiq_base_library","equipment"],"scripts":[],"document":null,"attributes":[],"description":"Base type of equipment types.","edit_status":1,"display_name":"Equipment","opcua_methods":[],"relative_name":"equipment","classification":"equipment","child_equipment":[],"sub_type_of_fqn":null,"updated_timestamp":"2022-08-02T00:48:48.107651+00:00","unlink_relative_name":false},{"fqn":["thinkiq_base_library","place"],"scripts":[],"document":null,"attributes":[],"description":"A physical location.","edit_status":1,"display_name":"Place","opcua_methods":[],"relative_name":"place","classification":"place","child_equipment":[],"sub_type_of_fqn":null,"updated_timestamp":"2022-08-02T00:48:48.107651+00:00","unlink_relative_name":false},{"fqn":["thinkiq_base_library","plant"],"scripts":[],"document":null,"attributes":[],"description":"A plant is a place inside a site.","edit_status":1,"display_name":"Plant","opcua_methods":[],"relative_name":"plant","classification":"place","child_equipment":[],"sub_type_of_fqn":["thinkiq_base_library","place"],"updated_timestamp":"2022-08-02T00:48:48.107651+00:00","unlink_relative_name":false}],"objects":[],"libraries":[{"fqn":["growatt"],"locked":false,"models":null,"aliases":null,"version":"1.0.0","document":null,"licensing":null,"extensions":null,"description":"Growatt Solar Inverter library","edit_status":1,"server_uris":null,"display_name":"Growatt","relative_name":"growatt","namespace_uris":null,"updated_timestamp":"2023-08-07T14:06:23.389653+00:00","unlink_relative_name":false},{"fqn":["thinkiq_base_library"],"locked":true,"models":null,"aliases":null,"version":"1.7.0","document":null,"licensing":"The ThinkIQ Base Library is copyright protected.","extensions":null,"description":"ThinkIQ Base Library","edit_status":1,"server_uris":null,"display_name":"ThinkIQ Base Library","relative_name":"thinkiq_base_library","namespace_uris":null,"updated_timestamp":"2023-07-14T00:24:58.550789+00:00","unlink_relative_name":false}],"quantities":[{"fqn":["thinkiq_base_library","energy_quantity"],"document":null,"description":"Capacity of a body or system to do work","edit_status":1,"display_name":"Energy quantity","relative_name":"energy_quantity","quantity_symbol":"J","updated_timestamp":"2022-09-14T05:16:01.824244+00:00","unlink_relative_name":false},{"fqn":["thinkiq_base_library","fraction_quantity"],"document":null,"description":"The ratio between two dimensionless numbers","edit_status":1,"display_name":"Fraction quantity","relative_name":"fraction_quantity","quantity_symbol":"Fraction","updated_timestamp":"2022-09-14T05:16:01.824244+00:00","unlink_relative_name":false},{"fqn":["thinkiq_base_library","power_quantity"],"document":null,"description":"Amount of energy transferred or converted per unit time","edit_status":1,"display_name":"Power quantity","relative_name":"power_quantity","quantity_symbol":"P","updated_timestamp":"2022-09-14T05:16:01.824244+00:00","unlink_relative_name":false}],"relationships":[],"attribute_types":[],"opcua_variables":[],"opcua_data_types":[],"script_templates":[],"enumeration_types":[],"measurement_units":[{"fqn":["thinkiq_base_library","kilowatt_hour"],"symbol":"kWh","document":null,"is_hidden":false,"unece_code":"KWH","unece_name":"kilowatt hour","description":null,"edit_status":1,"display_name":"kilowatt hour","quantity_fqn":["thinkiq_base_library","energy_quantity"],"opcua_unit_id":4937544,"relative_name":"kilowatt_hour","conversion_offset":0,"updated_timestamp":"2022-09-14T05:16:01.824244+00:00","unlink_relative_name":false,"conversion_multiplier":3600000},{"fqn":["thinkiq_base_library","percent"],"symbol":"%","document":null,"is_hidden":false,"unece_code":"P1","unece_name":"percent","description":null,"edit_status":1,"display_name":"percent","quantity_fqn":["thinkiq_base_library","fraction_quantity"],"opcua_unit_id":20529,"relative_name":"percent","conversion_offset":0,"updated_timestamp":"2022-09-14T05:16:01.824244+00:00","unlink_relative_name":false,"conversion_multiplier":1},{"fqn":["thinkiq_base_library","watt"],"symbol":"W","document":null,"is_hidden":false,"unece_code":"WTT","unece_name":"watt","description":null,"edit_status":1,"display_name":"watt","quantity_fqn":["thinkiq_base_library","power_quantity"],"opcua_unit_id":5723220,"relative_name":"watt","conversion_offset":0,"updated_timestamp":"2022-09-14T05:16:01.824244+00:00","unlink_relative_name":false,"conversion_multiplier":1}],"relationship_types":[],"opcua_variable_types":[],"opcua_reference_types":[],"md5_checksum":"e8e940953ab734865082cba3617f6b24"}